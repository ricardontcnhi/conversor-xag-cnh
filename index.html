<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Conversor Chassi XAG > CNH</title>
<meta name="theme-color" content="#0066cc" />
<link rel="manifest" href="manifest.json" />
<style>
*, *::before, *::after { box-sizing: border-box; }

body{
  margin:0;
  font-family:Arial;
  background:#f0f2f5;
  color:#222;
}

.header{
  background:#0066cc; color:white; padding:20px; text-align:center;
  font-size:24px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);
}

.container{
  padding:20px; max-width:920px; margin:0 auto;
}

.card{
  background:white; border-radius:12px; padding:20px; margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

label{
  font-size:16px; font-weight:bold; margin-top:10px; display:block;
}

input, select{
  width:100%; padding:15px; border-radius:8px; border:1px solid #ccc;
  margin-top:5px; font-size:16px; display:block;
}

button{
  width:100%; background:#0066cc; color:white; border:none; padding:15px;
  border-radius:8px; font-size:18px; margin-top:20px; cursor:pointer;
}

button:hover{ background:#0055aa; }

.copyBtn{
  background:#00aa55 !important;
}

#output{
  margin-top:15px; font-size:20px; font-weight:bold; color:green; text-align:center;
}

.footer{
  text-align:center; font-size:14px; color:#555; margin-top:20px; margin-bottom:20px;
}

.steps{ font-size:16px; line-height:1.6; }
.steps li{ margin-bottom:12px; }
</style>
</head>

<body>

<!-- Toast -->
<div id="toast" style="
  position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
  background: #0066cc; color: #fff; padding: 14px 22px; border-radius: 8px;
  font-size: 16px; display: none; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  transition: opacity 0.3s;">
</div>

<script>
function showToast(msg){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  t.style.opacity = "1";
  setTimeout(() => {
    t.style.opacity = "0";
    setTimeout(()=>{ t.style.display = "none"; }, 300);
  }, 2200);
}
</script>


<div class="header">Conversor Chassi XAG > CNH</div>

<div class="container">

  <div class="card">
    <h3>Conversor</h3>

    <label>Chassi XAG:</label>
    <input id="xag" maxlength="20" placeholder="Digite o chassi XAG" />

    <label>Marca:</label>
<select id="marca">
  <option value="" selected disabled>Selecione a marca...</option>
  <option value="New Holland">New Holland</option>
  <option value="Case">Case</option>
</select>

<label>Kit:</label>
<select id="kit">
  <option value="" selected disabled>Selecione o kit...</option>
  <option value="Basic">Basic</option>
  <option value="Full">Full</option>
</select>

<label>Ano‑modelo:</label>
<select id="anoModelo">
  <option value="" selected disabled>Selecione o ano...</option>
  <option value="2024">2024</option>
  <option value="2025">2025</option>
  <option value="2026">2026</option>
  <option value="2027">2027</option>
  <option value="2028">2028</option>
</select>

    <div id="output"></div>

    <button id="copyBtn" class="copyBtn" style="display:none;">Copiar CNH</button>
    <button id="clearBtn" style="background:#666; margin-top:10px;">Limpar Campos</button>
  </div>


  <!-- Contador Global -->
  <div id="contador" style="text-align:center; margin-top:20px; font-size:18px; color:#333;">
    Total de chassis convertidos: carregando...
  </div>


  <div class="card">
    <h3>Como adicionar como App no Celular</h3>
    <ol class="steps">
      <li>Abra este site no navegador oficial do celular.</li>
      <li>Aguarde aparecer o aviso: <b>“Adicionar à tela inicial”</b>.</li>
      <li>Se não aparecer, toque nos três pontinhos (⋮) do navegador</li>
      <li>Toque em <b>Adicionar à tela inicial</b>.</li>
      <li>Confirme e o WebAPK será instalado como aplicativo real.</li>
    </ol>
  </div>

  <div class="card">
    <h3>Como instalar no Computador</h3>
    <ol class="steps">
      <li>Abra o site no Edge/Chrome.</li>
      <li>Clique no ícone de instalação na barra de endereço.</li>
      <li>Confirme em <b>Instalar</b>.</li>
      <li>O app será instalado como programa independente.</li>
    </ol>
  </div>

  <div class="footer">
    Centro de Treinamento Curitiba - 12/02/2026 - Autor: Ricardo Tokumo
  </div>

</div>


<script>
// ---------- Tabela VIN ----------
const VIN_YEAR_CODE = {
  2020:'L', 2021:'M', 2022:'N', 2023:'P', 2024:'R', 2025:'S',
  2026:'T', 2027:'V', 2028:'W', 2029:'X'
};

// ---------- Elementos do DOM ----------
const $xag = document.getElementById('xag');
const $marca = document.getElementById('marca');
const $kit = document.getElementById('kit');
const $anoModelo = document.getElementById('anoModelo');
const $output = document.getElementById('output');
const $copyBtn = document.getElementById('copyBtn');
const $clearBtn = document.getElementById('clearBtn');
const $contador = document.getElementById('contador');

// Variáveis de Controle
let dadosEmEspera = null;
let ultimoXagEnviado = "";
const APP_URL = "https://script.google.com/macros/s/AKfycbzY-QIR1iSY-nHHKVx7yfw5LC0PlrJ33C1i76O1jkr1w2H8THz_m1zGZ_zur4oUvAUe0g/exec";

// ---------- Funções Principais ----------

function camposProntos() {
  // Ajustado para o comprimento de 20 conforme seu arquivo
  return $xag.value.trim().length === 20 && 
         $marca.value !== "" && 
         $kit.value !== "" && 
         $anoModelo.value !== "";
}

function montarCNH() {
  const x = $xag.value.trim();
  
  if (!camposProntos()) {
    $output.textContent = '';
    $copyBtn.style.display = 'none';
    return;
  }

  const b = ($marca.value === 'New Holland') ? 'N' : 'C';
  const c = ($kit.value === 'Basic') ? 'B' : 'F';
  const anoIndex = Number(x.charAt(12));
  const letraAno = VIN_YEAR_CODE[2020 + anoIndex];
  
  if (!letraAno) {
    $output.textContent = "Erro: Ano XAG inválido";
    return;
  }

  const r = 'X' + x.substring(4,6) + b + x.substring(6,8) + c + 
            (letraAno + String($anoModelo.value).slice(-1)) + 
            x.substring(12,13) + x.substring(13,15) + x.substring(15);

  $output.textContent = r;
  $copyBtn.style.display = 'block';

  if (dadosEmEspera && dadosEmEspera.xag !== x) {
    enviarParaPlanilha(dadosEmEspera);
  }

  dadosEmEspera = {
    xag: x,
    resultado: r,
    marca: $marca.value,
    kit: $kit.value,
    anoModelo: $anoModelo.value
  };
}

function enviarParaPlanilha(dados) {
  if (!dados || dados.xag === ultimoXagEnviado) return;
  ultimoXagEnviado = dados.xag;
  
  fetch(APP_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dados)
  });

  // Só tenta atualizar o contador se a página ainda estiver ativa
  if (document.visibilityState === 'visible') {
    setTimeout(atualizarContador, 4000);
  }
}

function atualizarContador() {
  // O "Cache Buster" usa milissegundos para garantir que cada requisição seja única
  const forcarAtualizacao = APP_URL + "?t=" + Math.random(); 
  
  fetch(forcarAtualizacao)
    .then(response => {
      if (!response.ok) throw new Error();
      return response.json();
    })
    .then(data => {
      if (data && typeof data.total !== 'undefined') {
        const elementoContador = document.getElementById("contador");
        // Efeito visual simples para mostrar que o número mudou
        elementoContador.style.opacity = "0.5";
        elementoContador.innerText = "Total de chassis convertidos: " + data.total;
        setTimeout(() => { elementoContador.style.opacity = "1"; }, 300);
      }
    })
    .catch(() => {
      console.log("Erro ao buscar contador. Tentando novamente...");
    });
}

$clearBtn.onclick = () => {
  if (dadosEmEspera && camposProntos()) {
    enviarParaPlanilha(dadosEmEspera);
    showToast('Campos limpos, preencha os dados!');
  } else {
    showToast('Campos limpos!');
  }
  
  $xag.value = "";
  $marca.selectedIndex = 0;
  $kit.selectedIndex = 0;
  $anoModelo.selectedIndex = 0;
  $output.textContent = "";
  $copyBtn.style.display = 'none';
  dadosEmEspera = null; 
  
  // Força uma atualização para garantir que o número mude após o envio
  setTimeout(atualizarContador, 2000);
};

$copyBtn.onclick = () => {
  navigator.clipboard.writeText($output.textContent)
    .then(() => showToast('Chassi CNH copiado!'))
    .catch(() => showToast('Erro ao copiar'));
};

// ---------- Eventos e Inicialização ----------
$xag.addEventListener('input', montarCNH);
$marca.addEventListener('change', montarCNH);
$kit.addEventListener('change', montarCNH);
$anoModelo.addEventListener('change', montarCNH);

document.addEventListener("DOMContentLoaded", atualizarContador);

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

// Detecta quando o usuário tenta atualizar (F5) ou fechar a aba
window.addEventListener('beforeunload', (event) => {
  // Se houver um chassi pronto que ainda não foi enviado
  if (dadosEmEspera && camposProntos() && dadosEmEspera.xag !== ultimoXagEnviado) {
    
    // Usamos o objeto 'navigator' que é mais confiável para envios ao fechar a página
    // Ele envia os dados mesmo que a aba feche imediatamente
    fetch(APP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dadosEmEspera)
    });
    
    // Opcional: Mostra um aviso padrão do navegador perguntando se deseja sair
    event.preventDefault();
    event.returnValue = '';
  }
});  
</script>


<!-- ANTI-CURIOUS COMPLETO -->
<script>
// (todo o seu código anti-curious foi mantido)
document.addEventListener("contextmenu", (e) => {
  const tag = (e.target.tagName || "").toLowerCase();
  if (["input", "select", "textarea"].includes(tag)) return;
  e.preventDefault();
}, { capture: true });

document.addEventListener("dragstart", (e) => e.preventDefault(), { capture: true });

(function preventCopyAndSelection(){
  const style = document.createElement("style");
  style.innerHTML = `
    body, .container, .card, .header, .footer {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
    }
    input, select, textarea {
      -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text;
    }
  `;
  document.head.appendChild(style);

  ["copy","cut"].forEach(evt => {
    document.addEventListener(evt, (e) => {
      const tag = (e.target.tagName || "").toLowerCase();
      if (!["input", "textarea"].includes(tag)) e.preventDefault();
    }, { capture: true });
  });
})();

document.addEventListener("keydown", (e) => {
  const k = e.key.toLowerCase();
  const ctrl = e.ctrlKey || e.metaKey;
  const shift = e.shiftKey;
  if (k === "f12" || (ctrl && shift && ["i","c","j"].includes(k))) {
    e.preventDefault(); e.stopPropagation();
  }
  if (ctrl && ["u","s","p"].includes(k)) {
    e.preventDefault(); e.stopPropagation();
  }
}, { capture: true });

(function blurConsole(){
  if (!window.console) return;
  try {
    const block = () => console.log("%cDevTools desabilitado", "font-size:16px;color:#c00;font-weight:bold");
    ["log","warn","info","debug"].forEach(fn => { try { console[fn] = block; } catch(_){} });
  } catch(_) {}
})();
</script>

</body>
</html>
