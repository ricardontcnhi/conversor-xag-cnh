<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Conversor Chassi XAG > CNH</title>
<meta name="theme-color" content="#0066cc" />
<link rel="manifest" href="manifest.json" />
<style>
*, *::before, *::after { box-sizing: border-box; }

body{
  margin:0;
  font-family:Arial;
  background:#f0f2f5;
  color:#222;
}

.header{
  background:#0066cc; color:white; padding:20px; text-align:center;
  font-size:24px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);
}

.container{
  padding:20px; max-width:920px; margin:0 auto;
}

.card{
  background:white; border-radius:12px; padding:20px; margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

label{
  font-size:16px; font-weight:bold; margin-top:10px; display:block;
}

input, select{
  width:100%; padding:15px; border-radius:8px; border:1px solid #ccc;
  margin-top:5px; font-size:16px; display:block;
}

button{
  width:100%; background:#0066cc; color:white; border:none; padding:15px;
  border-radius:8px; font-size:18px; margin-top:20px; cursor:pointer;
}

button:hover{ background:#0055aa; }

.copyBtn{
  background:#00aa55 !important;
}

#output{
  margin-top:15px; font-size:20px; font-weight:bold; color:green; text-align:center;
}

.footer{
  text-align:center; font-size:14px; color:#555; margin-top:20px; margin-bottom:20px;
}

.steps{ font-size:16px; line-height:1.6; }
.steps li{ margin-bottom:12px; }
</style>
</head>

<body>

<!-- Toast -->
<div id="toast" style="
  position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
  background: #0066cc; color: #fff; padding: 14px 22px; border-radius: 8px;
  font-size: 16px; display: none; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  transition: opacity 0.3s;">
</div>

<script>
function showToast(msg){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  t.style.opacity = "1";
  setTimeout(() => {
    t.style.opacity = "0";
    setTimeout(()=>{ t.style.display = "none"; }, 300);
  }, 2200);
}
</script>


<div class="header">Conversor Chassi XAG > CNH</div>

<div class="container">

  <div class="card">
    <h3>Conversor</h3>

    <label>Chassi XAG:</label>
    <input id="xag" maxlength="20" placeholder="Digite o chassi XAG" />

    <label>Marca:</label>
<select id="marca">
  <option value="" selected disabled>Selecione a marca...</option>
  <option value="New Holland">New Holland</option>
  <option value="Case">Case</option>
</select>

<label>Kit:</label>
<select id="kit">
  <option value="" selected disabled>Selecione o kit...</option>
  <option value="Basic">Basic</option>
  <option value="Full">Full</option>
</select>

<label>Ano‑modelo:</label>
<select id="anoModelo">
  <option value="" selected disabled>Selecione o ano...</option>
  <option value="2024">2024</option>
  <option value="2025">2025</option>
  <option value="2026">2026</option>
  <option value="2027">2027</option>
  <option value="2028">2028</option>
</select>

    <div id="output"></div>

    <button id="copyBtn" class="copyBtn" style="display:none;">Copiar CNH</button>
    <button id="clearBtn" style="background:#666; margin-top:10px;">Limpar Campos</button>
  </div>


  <!-- Contador Global -->
  <div id="contador" style="text-align:center; margin-top:20px; font-size:18px; color:#333;">
    Total de chassis convertidos: carregando...
  </div>


  <div class="card">
    <h3>Como adicionar como App no Celular</h3>
    <ol class="steps">
      <li>Abra este site no navegador oficial do celular.</li>
      <li>Aguarde aparecer o aviso: <b>“Adicionar à tela inicial”</b>.</li>
      <li>Se não aparecer, toque nos três pontinhos (⋮) do navegador</li>
      <li>Toque em <b>Adicionar à tela inicial</b>.</li>
      <li>Confirme e o WebAPK será instalado como aplicativo real.</li>
    </ol>
  </div>

  <div class="card">
    <h3>Como instalar no Computador</h3>
    <ol class="steps">
      <li>Abra o site no Edge/Chrome.</li>
      <li>Clique no ícone de instalação na barra de endereço.</li>
      <li>Confirme em <b>Instalar</b>.</li>
      <li>O app será instalado como programa independente.</li>
    </ol>
  </div>

  <div class="footer">
    Centro de Treinamento Curitiba - 12/02/2026 - Autor: Ricardo Tokumo
  </div>

</div>


<script>
// ---------- Tabela VIN ----------
const VIN_YEAR_CODE = {
  2020:'L', 2021:'M', 2022:'N', 2023:'P', 2024:'R', 2025:'S',
  2026:'T', 2027:'V', 2028:'W', 2029:'X'
};

// ---------- Inputs ----------
const $xag = document.getElementById('xag');
const $marca = document.getElementById('marca');
const $kit = document.getElementById('kit');
const $anoModelo = document.getElementById('anoModelo');
const $output = document.getElementById('output');
const $copyBtn = document.getElementById('copyBtn');

// Variável global para rastrear o último envio bem-sucedido
// Variável global para rastrear APENAS o último Chassi XAG enviado com sucesso
let ultimoXagEnviado = "";

function camposProntos(){
  // Verifica se o chassi tem os 21 caracteres e se todos os selects foram escolhidos
  return $xag.value.trim().length === 20 &&
         $marca.value !== "" && 
         $kit.value !== "" && 
         $anoModelo.value !== "";
}

function montarCNH(){
  const x = $xag.value.trim();
  const marca = $marca.value;
  const kit   = $kit.value;
  const anoModelo = $anoModelo.value;

  // 1. Validação básica: se não estiver tudo preenchido, limpa o output e para.
  if (!camposProntos()){
    $output.textContent = '';
    $copyBtn.style.display = 'none';
    return;
  }

  // --- Lógica de cálculo do Chassi CNH ---
  const b = (marca === 'New Holland') ? 'N' : 'C';
  const c = (kit === 'Basic') ? 'B' : 'F';
  const anoXAGdigit = x.charAt(12);
  const anoFabricacao = 2020 + Number(anoXAGdigit);
  const letraBloco = VIN_YEAR_CODE[anoFabricacao];

  if (!letraBloco){
    showToast('Ano XAG inválido');
    return;
  }

  const digitoModelo = String(anoModelo).slice(-1);
  const blocoVariante = letraBloco + digitoModelo;
  const anoXAG    = x.substring(12,13);
  const semanaXAG = x.substring(13,15);
  const randomXAG = x.substring(15);

  const r = 'X' + x.substring(4,6) + b + x.substring(6,8) + c + 
            blocoVariante + anoXAG + semanaXAG + randomXAG;

  // Atualiza a tela para o usuário
  $output.textContent = r;
  $copyBtn.style.display = 'block';
  $copyBtn.onclick = () => {
    navigator.clipboard.writeText(r)
      .then(()=> showToast('Chassi CNH copiado!'))
      .catch(()=> showToast('Erro ao copiar'));
  };

  // 2. REGRA DE OURO: Só envia para o Sheets se o INPUT do Chassi XAG mudou
  if (x === ultimoXagEnviado) {
    return; // Se o XAG digitado for o mesmo do último envio, ignora o fetch
  }
  
  // Atualiza a trava com o chassi atual antes de enviar
  ultimoXagEnviado = x;

  // ====== Enviar para Google Sheets ======
  fetch("https://script.google.com/macros/s/AKfycbzY-QIR1iSY-nHHKVx7yfw5LC0PlrJ33C1i76O1jkr1w2H8THz_m1zGZ_zur4oUvAUe0g/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      xag: x,
      resultado: r,
      marca: marca,
      kit: kit,
      anoModelo: anoModelo
    })
  });

  setTimeout(atualizarContador, 2000);
}

// Ouvintes de eventos simplificados
$xag.addEventListener('input', montarCNH);
$marca.addEventListener('change', montarCNH);
$kit.addEventListener('change', montarCNH);
$anoModelo.addEventListener('change', montarCNH);

// ===== Contador global =====
function atualizarContador(){
  fetch("https://script.google.com/macros/s/AKfycbzY-QIR1iSY-nHHKVx7yfw5LC0PlrJ33C1i76O1jkr1w2H8THz_m1zGZ_zur4oUvAUe0g/exec")
    .then(r => r.json())
    .then(data => {
      document.getElementById("contador").innerText =
        "Total de chassis convertidos: " + data.total;
    })
    .catch(()=> {
      document.getElementById("contador").innerText =
        "Total de chassis convertidos: (erro ao carregar)";
    });
}

document.addEventListener("DOMContentLoaded", atualizarContador);
const $clearBtn = document.getElementById('clearBtn');

$clearBtn.onclick = () => {
  // Limpa o campo de texto
  $xag.value = "";
  
  // Reseta os selects para a primeira opção (Selecione...)
  $marca.selectedIndex = 0;
  $kit.selectedIndex = 0;
  $anoModelo.selectedIndex = 0;
  
  // Limpa o resultado visual e esconde o botão de copiar
  $output.textContent = "";
  $copyBtn.style.display = 'none';
  
 
  
  showToast('Campos zerados!');
};

// ===== Service Worker =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>


<!-- ANTI-CURIOUS COMPLETO -->
<script>
// (todo o seu código anti-curious foi mantido)
document.addEventListener("contextmenu", (e) => {
  const tag = (e.target.tagName || "").toLowerCase();
  if (["input", "select", "textarea"].includes(tag)) return;
  e.preventDefault();
}, { capture: true });

document.addEventListener("dragstart", (e) => e.preventDefault(), { capture: true });

(function preventCopyAndSelection(){
  const style = document.createElement("style");
  style.innerHTML = `
    body, .container, .card, .header, .footer {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
    }
    input, select, textarea {
      -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text;
    }
  `;
  document.head.appendChild(style);

  ["copy","cut"].forEach(evt => {
    document.addEventListener(evt, (e) => {
      const tag = (e.target.tagName || "").toLowerCase();
      if (!["input", "textarea"].includes(tag)) e.preventDefault();
    }, { capture: true });
  });
})();

document.addEventListener("keydown", (e) => {
  const k = e.key.toLowerCase();
  const ctrl = e.ctrlKey || e.metaKey;
  const shift = e.shiftKey;
  if (k === "f12" || (ctrl && shift && ["i","c","j"].includes(k))) {
    e.preventDefault(); e.stopPropagation();
  }
  if (ctrl && ["u","s","p"].includes(k)) {
    e.preventDefault(); e.stopPropagation();
  }
}, { capture: true });

(function blurConsole(){
  if (!window.console) return;
  try {
    const block = () => console.log("%cDevTools desabilitado", "font-size:16px;color:#c00;font-weight:bold");
    ["log","warn","info","debug"].forEach(fn => { try { console[fn] = block; } catch(_){} });
  } catch(_) {}
})();
</script>

</body>
</html>
